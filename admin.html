<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Admin SOFTT</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/papaparse@latest/papaparse.min.js"></script>
    <style>
        :root {
            --brand-red: #D32F2F;
            --brand-red-dark: #B71C1C;
        }
        .bg-brand-red { background-color: var(--brand-red); }
        .hover\:bg-brand-red-dark:hover { background-color: var(--brand-red-dark); }
        .text-brand-red { color: var(--brand-red); }
        .border-brand-red { border-color: var(--brand-red); }
        .ring-brand-red:focus { ring-color: var(--brand-red); }
        .modal { display: none; }
        .modal.active { display: flex; }
    </style>
</head>
<body class="bg-gray-100 font-sans antialiased">

    <!-- Kontainer Utama Aplikasi -->
    <div id="app-container">

        <!-- Halaman Login -->
        <div id="login-page" class="min-h-screen flex items-center justify-center bg-gray-200 p-4">
            <div class="w-full max-w-md bg-white rounded-2xl shadow-xl p-8 space-y-6">
                <div class="text-center">
                    <h1 class="text-3xl font-bold text-brand-red">Panel Admin SOFTT</h1>
                    <p class="text-gray-500 mt-2">Silakan login untuk melanjutkan</p>
                </div>
                <form id="login-form">
                    <div class="space-y-4">
                        <input type="email" id="email" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-red" placeholder="admin@softt.com">
                        <input type="password" id="password" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-red" placeholder="••••••••">
                        <button type="submit" id="login-button" class="w-full py-3 px-4 rounded-lg font-medium text-white bg-brand-red hover:bg-brand-red-dark focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-brand-red transition-all duration-300">
                            <span id="login-button-text">Login</span>
                        </button>
                    </div>
                </form>
                <p id="login-error" class="mt-4 text-center text-red-600 text-sm font-medium"></p>
            </div>
        </div>

        <!-- Dasbor Admin -->
        <div id="dashboard-page" class="hidden min-h-screen">
            <div class="flex w-full">
                <!-- Sidebar Navigasi -->
                <aside class="w-64 bg-gray-800 text-white flex flex-col flex-shrink-0">
                    <div class="p-4 border-b border-gray-700">
                        <h2 class="text-xl font-bold">Admin SOFTT</h2>
                        <p id="admin-email" class="text-xs text-gray-400 truncate"></p>
                    </div>
                    <nav class="flex-grow p-4 space-y-2">
                        <a href="#" data-target="manage-program" class="nav-link flex items-center px-3 py-2 rounded-lg bg-gray-700">Program Konferensi</a>
                        <a href="#" data-target="manage-schedule" class="nav-link flex items-center px-3 py-2 rounded-lg hover:bg-gray-700">Jadwal Umum</a>
                        <a href="#" data-target="manage-speakers" class="nav-link flex items-center px-3 py-2 rounded-lg hover:bg-gray-700">Pembicara</a>
                    </nav>
                    <div class="p-4 border-t border-gray-700">
                        <button id="logout-button" class="w-full flex items-center justify-center px-3 py-2 rounded-lg text-white bg-red-600 hover:bg-red-700 transition-colors">Logout</button>
                    </div>
                </aside>

                <!-- Konten Utama Dasbor -->
                <main class="flex-grow p-8 bg-gray-50 overflow-y-auto">
                    <!-- Konten Program Konferensi -->
                    <div id="manage-program" class="dashboard-content">
                        <div class="flex justify-between items-center">
                            <h1 class="text-3xl font-bold text-gray-800">Program Konferensi</h1>
                            <button id="add-track-button" class="bg-brand-red text-white px-4 py-2 rounded-lg hover:bg-brand-red-dark">Tambah Track</button>
                        </div>
                        <div id="program-list" class="mt-6 space-y-4"></div>
                    </div>

                    <!-- Konten Jadwal Umum -->
                    <div id="manage-schedule" class="dashboard-content hidden">
                        <div class="flex justify-between items-center">
                            <h1 class="text-3xl font-bold text-gray-800">Jadwal Umum</h1>
                            <button id="add-session-button" class="bg-brand-red text-white px-4 py-2 rounded-lg hover:bg-brand-red-dark">Tambah Sesi</button>
                        </div>
                        <div id="schedule-list" class="mt-6 space-y-3"></div>
                    </div>

                    <!-- Konten Pembicara -->
                    <div id="manage-speakers" class="dashboard-content hidden">
                        <h1 class="text-3xl font-bold text-gray-800">Kelola Pembicara</h1>
                        <div class="mt-6 bg-white p-6 rounded-lg shadow">
                            <h2 class="text-xl font-semibold text-gray-700">Impor dari File CSV</h2>
                            <input type="file" id="csv-file-input" accept=".csv" class="mt-4 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:bg-red-50 file:text-brand-red hover:file:bg-red-100"/>
                            <p id="import-status" class="mt-2 text-sm text-gray-600"></p>
                        </div>
                        <div class="mt-8">
                            <h2 class="text-xl font-semibold text-gray-700">Daftar Pembicara</h2>
                            <div id="speakers-list" class="mt-4 space-y-3"></div>
                        </div>
                    </div>
                </main>
            </div>
        </div>
    </div>

    <!-- Modal Dialog -->
    <div id="modal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-full overflow-y-auto">
            <div class="p-6 border-b flex justify-between items-center">
                <h3 id="modal-title" class="text-xl font-semibold">Modal Title</h3>
                <button id="modal-close" class="text-gray-400 hover:text-gray-600">&times;</button>
            </div>
            <div id="modal-body" class="p-6"></div>
        </div>
    </div>

    <script type="module">
        // --- Inisialisasi Klien Supabase ---
        const SUPABASE_URL = 'https://eahzvovzbxeccneufvec.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVhaHp2b3Z6YnhlY2NuZXVmdmVjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE1Mjc3NjMsImV4cCI6MjA2NzEwMzc2M30.Ix-UV3P6PXgw3tW0hDK0_f1x3jAWi-YJYYAC9satLdo';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // --- State Aplikasi ---
        let speakersCache = [];
        let programCache = [];
        let scheduleCache = [];

        // --- Elemen DOM ---
        const loginPage = document.getElementById('login-page');
        const dashboardPage = document.getElementById('dashboard-page');
        const loginForm = document.getElementById('login-form');
        const loginError = document.getElementById('login-error');
        const logoutButton = document.getElementById('logout-button');
        const adminEmail = document.getElementById('admin-email');
        const navLinks = document.querySelectorAll('.nav-link');
        const dashboardContents = document.querySelectorAll('.dashboard-content');
        
        // --- Fungsi Utama ---
        async function init() {
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (session) {
                const { data: profile } = await supabaseClient.from('profiles').select('role').eq('id', session.user.id).single();
                if (profile && profile.role === 'admin') {
                    showDashboard(session.user);
                } else {
                    showLoginPage();
                }
            } else {
                showLoginPage();
            }
        }

        function showLoginPage() {
            loginPage.classList.remove('hidden');
            dashboardPage.classList.add('hidden');
        }

        async function showDashboard(user) {
            loginPage.classList.add('hidden');
            dashboardPage.classList.remove('hidden');
            adminEmail.textContent = user.email;
            await loadAllData();
        }

        async function loadAllData() {
            // Load all data concurrently
            const [programRes, speakersRes, scheduleRes] = await Promise.all([
                supabaseClient.from('tracks').select(`*, topics(*, papers(*, speakers(name)))`).order('name'),
                supabaseClient.from('speakers').select('*').order('name'),
                supabaseClient.from('sessions').select('*').order('start_time')
            ]);

            if (programRes.error) console.error("Error loading program:", programRes.error);
            else programCache = programRes.data;

            if (speakersRes.error) console.error("Error loading speakers:", speakersRes.error);
            else speakersCache = speakersRes.data;
            
            if (scheduleRes.error) console.error("Error loading schedule:", scheduleRes.error);
            else scheduleCache = scheduleRes.data;

            renderProgram();
            renderSpeakers();
            renderSchedule();
        }

        // --- Render Functions ---
        function renderProgram() {
            const container = document.getElementById('program-list');
            if (programCache.length === 0) {
                container.innerHTML = '<p>Belum ada program yang dibuat.</p>';
                return;
            }
            container.innerHTML = programCache.map(track => `
                <div class="bg-white rounded-lg shadow-md p-4">
                    <div class="flex justify-between items-center">
                        <h3 class="text-xl font-bold text-gray-800">${track.name}</h3>
                        <div>
                            <button class="add-topic-btn text-green-500 hover:text-green-700" data-track-id="${track.id}">Tambah Topik</button>
                            <button class="edit-track-btn text-blue-500 hover:text-blue-700 ml-2" data-track-id="${track.id}">Edit</button>
                        </div>
                    </div>
                    <div class="mt-4 pl-4 border-l-2 border-gray-200 space-y-3">
                        ${track.topics.map(topic => `
                            <div class="bg-gray-50 p-3 rounded-md">
                                <div class="flex justify-between items-center">
                                    <h4 class="font-semibold text-gray-700">${topic.name}</h4>
                                    <div>
                                        <button class="add-paper-btn text-green-500 hover:text-green-700 text-sm" data-topic-id="${topic.id}">Tambah Paper</button>
                                        <button class="edit-topic-btn text-blue-500 hover:text-blue-700 ml-2 text-sm" data-topic-id="${topic.id}" data-track-id="${track.id}">Edit</button>
                                    </div>
                                </div>
                                <div class="mt-2 pl-4 space-y-2">
                                    ${topic.papers.map(paper => `
                                        <div class="border-t pt-2">
                                            <p class="font-medium">${paper.title}</p>
                                            <p class="text-sm text-gray-500">
                                                Pembicara: ${paper.speakers?.name || 'N/A'} | Ruang: ${paper.room || 'N/A'} | Waktu: ${paper.start_time ? new Date(paper.start_time).toLocaleTimeString('id-ID', {hour: '2-digit', minute:'2-digit'}) : 'N/A'}
                                            </p>
                                            <div class="text-right">
                                                <button class="edit-paper-btn text-blue-500 hover:text-blue-700 text-xs" data-paper-id="${paper.id}" data-topic-id="${topic.id}">Edit</button>
                                            </div>
                                        </div>
                                    `).join('') || '<p class="text-xs text-gray-400">Belum ada paper.</p>'}
                                </div>
                            </div>
                        `).join('') || '<p class="text-sm text-gray-400">Belum ada topik.</p>'}
                    </div>
                </div>
            `).join('');
        }

        function renderSpeakers() {
            // ... implementasi render speaker
        }
        
        function renderSchedule() {
            // ... implementasi render jadwal umum
        }

        // --- Modal & Form Handling ---
        // ... (implementasi fungsi untuk membuka modal dan menyimpan data)

        // --- Event Listeners ---
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            loginError.textContent = '';
            const email = loginForm.email.value;
            const password = loginForm.password.value;
            const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });

            if (error) {
                loginError.textContent = 'Login gagal: ' + error.message;
            } else {
                init(); // Re-initialize app state
            }
        });

        logoutButton.addEventListener('click', async () => {
            await supabaseClient.auth.signOut();
            location.reload();
        });

        navLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const targetId = link.getAttribute('data-target');
                dashboardContents.forEach(content => content.classList.add('hidden'));
                document.getElementById(targetId).classList.remove('hidden');
                navLinks.forEach(nav => nav.classList.remove('bg-gray-700'));
                link.classList.add('bg-gray-700');
            });
        });
        
        // --- Inisialisasi Aplikasi ---
        init();
    </script>
</body>
</html>
