<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Admin SOFTT</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/papaparse@latest/papaparse.min.js"></script>
    <style>
        :root {
            --brand-red: #D32F2F;
            --brand-red-dark: #B71C1C;
        }
        .bg-brand-red { background-color: var(--brand-red); }
        .hover\:bg-brand-red-dark:hover { background-color: var(--brand-red-dark); }
        .text-brand-red { color: var(--brand-red); }
        .border-brand-red { border-color: var(--brand-red); }
        .ring-brand-red:focus { ring-color: var(--brand-red); }
        .modal { display: none; }
        .modal.active { display: flex; }
        .btn { @apply px-4 py-2 rounded-lg text-white transition-colors text-sm font-medium; }
        .btn-primary { @apply bg-brand-red hover:bg-brand-red-dark; }
        .btn-secondary { @apply bg-gray-600 hover:bg-gray-700; }
        .btn-edit { @apply text-blue-600 hover:text-blue-800 text-sm; }
        .btn-delete { @apply text-red-600 hover:text-red-800 text-sm ml-2; }
        .btn-add { @apply text-green-600 hover:text-green-800 text-sm; }
        .input-field { @apply mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-brand-red focus:border-brand-red; }
    </style>
</head>
<body class="bg-gray-100 font-sans antialiased">

    <!-- Kontainer Utama Aplikasi -->
    <div id="app-container">

        <!-- Halaman Login -->
        <div id="login-page" class="min-h-screen flex items-center justify-center bg-gray-200 p-4">
            <div class="w-full max-w-md bg-white rounded-2xl shadow-xl p-8 space-y-6">
                <div class="text-center">
                    <h1 class="text-3xl font-bold text-brand-red">Panel Admin SOFTT</h1>
                    <p class="text-gray-500 mt-2">Silakan login untuk melanjutkan</p>
                </div>
                <form id="login-form">
                    <div class="space-y-4">
                        <input type="email" id="email" required class="input-field" placeholder="admin@softt.com">
                        <input type="password" id="password" required class="input-field" placeholder="••••••••">
                        <button type="submit" id="login-button" class="w-full btn btn-primary py-3">Login</button>
                    </div>
                </form>
                <p id="login-error" class="mt-4 text-center text-red-600 text-sm font-medium"></p>
            </div>
        </div>

        <!-- Dasbor Admin -->
        <div id="dashboard-page" class="hidden min-h-screen">
            <div class="flex w-full h-screen">
                <!-- Sidebar Navigasi -->
                <aside class="w-64 bg-gray-800 text-white flex flex-col flex-shrink-0">
                    <div class="p-4 border-b border-gray-700">
                        <h2 class="text-xl font-bold">Admin SOFTT</h2>
                        <p id="admin-email" class="text-xs text-gray-400 truncate"></p>
                    </div>
                    <!-- FIX: Added ID to nav container for event delegation -->
                    <nav id="sidebar-nav" class="flex-grow p-4 space-y-2">
                        <a href="#" data-target="manage-program" class="nav-link flex items-center px-3 py-2 rounded-lg bg-gray-700">
                            <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                            Program
                        </a>
                        <a href="#" data-target="manage-schedule" class="nav-link flex items-center px-3 py-2 rounded-lg hover:bg-gray-700">
                            <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                            Jadwal Umum
                        </a>
                        <a href="#" data-target="manage-speakers" class="nav-link flex items-center px-3 py-2 rounded-lg hover:bg-gray-700">
                            <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                            Pembicara
                        </a>
                    </nav>
                    <div class="p-4 border-t border-gray-700">
                        <button id="logout-button" class="w-full btn bg-red-600 hover:bg-red-700">Logout</button>
                    </div>
                </aside>

                <!-- Konten Utama Dasbor -->
                <main class="flex-grow p-8 bg-gray-50 overflow-y-auto">
                    <!-- Konten Program Konferensi -->
                    <div id="manage-program" class="dashboard-content">
                        <div class="flex justify-between items-center mb-6">
                            <h1 class="text-3xl font-bold text-gray-800">Program Konferensi</h1>
                            <button id="add-track-button" class="btn btn-primary">Tambah Track</button>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow mb-6">
                            <h2 class="text-xl font-semibold text-gray-700">Impor Paper dari CSV</h2>
                            <p class="text-sm text-gray-500 mt-1">Kolom wajib: `track_name`, `topic_name`, `paper_title`. Kolom opsional: `speaker_name`, `paper_abstract`, `room`, `start_time`, `end_time`.</p>
                            <input type="file" id="program-csv-input" accept=".csv" class="mt-4 block w-full text-sm"/>
                        </div>
                        <div id="program-list" class="space-y-4"></div>
                    </div>

                    <!-- Konten Jadwal Umum -->
                    <div id="manage-schedule" class="dashboard-content hidden">
                         <div class="flex justify-between items-center mb-6">
                            <h1 class="text-3xl font-bold text-gray-800">Jadwal Umum</h1>
                            <button id="add-session-button" class="btn btn-primary">Tambah Sesi</button>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow mb-6">
                            <h2 class="text-xl font-semibold text-gray-700">Impor Sesi dari CSV</h2>
                             <p class="text-sm text-gray-500 mt-1">Kolom wajib: `title`, `start_time`, `end_time`. Kolom opsional: `speaker`, `description`.</p>
                            <input type="file" id="schedule-csv-input" accept=".csv" class="mt-4 block w-full text-sm"/>
                        </div>
                        <div id="schedule-list" class="mt-6 bg-white p-4 rounded-lg shadow"></div>
                    </div>

                    <!-- Konten Pembicara -->
                    <div id="manage-speakers" class="dashboard-content hidden">
                        <div class="flex justify-between items-center mb-6">
                            <h1 class="text-3xl font-bold text-gray-800">Kelola Pembicara</h1>
                            <button id="add-speaker-button" class="btn btn-primary">Tambah Pembicara</button>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow">
                            <h2 class="text-xl font-semibold text-gray-700">Impor Pembicara dari CSV</h2>
                            <p class="text-sm text-gray-500 mt-1">Kolom wajib: `name`. Kolom opsional: `avatar_url`.</p>
                            <input type="file" id="speaker-csv-input" accept=".csv" class="mt-4 block w-full text-sm"/>
                        </div>
                        <div class="mt-8">
                            <h2 class="text-xl font-semibold text-gray-700">Daftar Pembicara</h2>
                            <div id="speakers-list" class="mt-4 space-y-3"></div>
                        </div>
                    </div>
                </main>
            </div>
        </div>
    </div>

    <!-- Modal Dialog -->
    <div id="modal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-full">
            <div class="p-4 border-b flex justify-between items-center">
                <h3 id="modal-title" class="text-xl font-semibold"></h3>
                <button id="modal-close" class="text-2xl font-bold text-gray-400 hover:text-gray-600">&times;</button>
            </div>
            <div id="modal-body" class="p-6 overflow-y-auto" style="max-height: 70vh;"></div>
        </div>
    </div>

    <script type="module">
        // --- Inisialisasi Klien Supabase ---
        const SUPABASE_URL = 'https://eahzvovzbxeccneufvec.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVhaHp2b3Z6YnhlY2NuZXVmdmVjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE1Mjc3NjMsImV4cCI6MjA2NzEwMzc2M30.Ix-UV3P6PXgw3tW0hDK0_f1x3jAWi-YJYYAC9satLdo';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // --- State Aplikasi ---
        let speakersCache = [];
        let programCache = [];
        let scheduleCache = [];

        // --- Elemen DOM ---
        const loginPage = document.getElementById('login-page');
        const dashboardPage = document.getElementById('dashboard-page');
        const loginForm = document.getElementById('login-form');
        const loginError = document.getElementById('login-error');
        const logoutButton = document.getElementById('logout-button');
        const adminEmail = document.getElementById('admin-email');
        const sidebarNav = document.getElementById('sidebar-nav'); // FIX: Get nav container
        const dashboardContents = document.querySelectorAll('.dashboard-content');
        const modal = document.getElementById('modal');
        const modalTitle = document.getElementById('modal-title');
        const modalBody = document.getElementById('modal-body');
        const modalClose = document.getElementById('modal-close');
        
        // --- Fungsi Utama ---
        async function init() {
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (session) {
                const { data: profile } = await supabaseClient.from('profiles').select('role').eq('id', session.user.id).single();
                if (profile && profile.role === 'admin') {
                    showDashboard(session.user);
                } else {
                    await supabaseClient.auth.signOut();
                    showLoginPage('Akses ditolak. Akun ini bukan admin.');
                }
            } else {
                showLoginPage();
            }
        }

        function showLoginPage(errorMsg = '') {
            loginPage.classList.remove('hidden');
            dashboardPage.classList.add('hidden');
            if(errorMsg) loginError.textContent = errorMsg;
        }

        async function showDashboard(user) {
            loginPage.classList.add('hidden');
            dashboardPage.classList.remove('hidden');
            adminEmail.textContent = user.email;
            await loadAllData();
        }

        async function loadAllData() {
            const [programRes, speakersRes, scheduleRes] = await Promise.all([
                supabaseClient.from('tracks').select(`*, topics(*, papers(*, speakers(name)))`).order('name'),
                supabaseClient.from('speakers').select('*').order('name'),
                supabaseClient.from('sessions').select('*').order('start_time')
            ]);

            programCache = programRes.data || [];
            speakersCache = speakersRes.data || [];
            scheduleCache = scheduleRes.data || [];

            renderProgram();
            renderSpeakers();
            renderSchedule();
        }

        // --- Render Functions ---
        function renderSpeakers() {
            const container = document.getElementById('speakers-list');
            if (speakersCache.length === 0) {
                container.innerHTML = '<p>Belum ada data pembicara.</p>';
                return;
            }
            container.innerHTML = speakersCache.map(speaker => `
                <div class="bg-white p-3 rounded-lg shadow-sm flex items-center justify-between">
                    <div class="flex items-center">
                        <img src="${speaker.avatar_url || 'https://placehold.co/40x40'}" alt="${speaker.name}" class="w-10 h-10 rounded-full mr-4 object-cover">
                        <span class="font-medium">${speaker.name}</span>
                    </div>
                    <div>
                        <button class="edit-speaker-btn btn-edit" data-id="${speaker.id}">Edit</button>
                        <button class="delete-speaker-btn btn-delete" data-id="${speaker.id}" data-name="${speaker.name}">Hapus</button>
                    </div>
                </div>
            `).join('');
        }

        function renderSchedule() {
            const container = document.getElementById('schedule-list');
            if (scheduleCache.length === 0) {
                container.innerHTML = '<p>Belum ada jadwal umum.</p>';
                return;
            }
            container.innerHTML = scheduleCache.map(session => `
                <div class="bg-gray-50 p-3 rounded-md flex justify-between items-center">
                    <div>
                        <p class="font-semibold">${session.title}</p>
                        <p class="text-sm text-gray-600">${new Date(session.start_time).toLocaleString('id-ID')} - ${new Date(session.end_time).toLocaleTimeString('id-ID', {hour: '2-digit', minute:'2-digit'})}</p>
                    </div>
                    <div>
                        <button class="edit-session-btn btn-edit" data-id="${session.id}">Edit</button>
                        <button class="delete-session-btn btn-delete" data-id="${session.id}" data-name="${session.title}">Hapus</button>
                    </div>
                </div>
            `).join('');
        }

        function renderProgram() {
            const container = document.getElementById('program-list');
            if (programCache.length === 0) {
                container.innerHTML = '<p>Belum ada program yang dibuat.</p>';
                return;
            }
            container.innerHTML = programCache.map(track => `
                <div class="bg-white rounded-lg shadow-md p-4">
                    <div class="flex justify-between items-center">
                        <h3 class="text-xl font-bold text-gray-800">${track.name}</h3>
                        <div>
                            <button class="add-topic-btn btn-add" data-track-id="${track.id}">Tambah Topik</button>
                            <button class="edit-track-btn btn-edit ml-2" data-id="${track.id}">Edit</button>
                            <button class="delete-track-btn btn-delete" data-id="${track.id}" data-name="${track.name}">Hapus</button>
                        </div>
                    </div>
                    <div class="mt-4 pl-4 border-l-2 border-gray-200 space-y-3">
                        ${track.topics.map(topic => `
                            <div class="bg-gray-50 p-3 rounded-md">
                                <div class="flex justify-between items-center">
                                    <h4 class="font-semibold text-gray-700">${topic.name}</h4>
                                    <div>
                                        <button class="add-paper-btn btn-add" data-topic-id="${topic.id}">Tambah Paper</button>
                                        <button class="edit-topic-btn btn-edit ml-2" data-id="${topic.id}" data-track-id="${track.id}">Edit</button>
                                        <button class="delete-topic-btn btn-delete" data-id="${topic.id}" data-name="${topic.name}">Hapus</button>
                                    </div>
                                </div>
                                <div class="mt-2 pl-4 space-y-2">
                                    ${topic.papers.map(paper => `
                                        <div class="border-t pt-2">
                                            <p class="font-medium">${paper.title}</p>
                                            <p class="text-sm text-gray-500">Pembicara: ${paper.speakers?.name || 'N/A'} | Ruang: ${paper.room || 'N/A'}</p>
                                            <div class="text-right">
                                                <button class="edit-paper-btn btn-edit" data-id="${paper.id}" data-topic-id="${topic.id}">Edit</button>
                                                <button class="delete-paper-btn btn-delete" data-id="${paper.id}" data-name="${paper.title}">Hapus</button>
                                            </div>
                                        </div>
                                    `).join('') || '<p class="text-xs text-gray-400">Belum ada paper.</p>'}
                                </div>
                            </div>
                        `).join('') || '<p class="text-sm text-gray-400">Belum ada topik.</p>'}
                    </div>
                </div>
            `).join('');
        }
        
        // --- Form Generators ---
        function createForm(fields, onSubmit) {
            const form = document.createElement('form');
            form.className = 'space-y-4';
            form.id = 'modal-form';
            form.innerHTML = fields.map(f => `
                <div>
                    <label for="${f.id}" class="block text-sm font-medium text-gray-700">${f.label}</label>
                    ${f.type === 'textarea' 
                        ? `<textarea id="${f.id}" name="${f.id}" class="input-field" rows="5">${f.value || ''}</textarea>`
                        : f.type === 'select'
                        ? `<select id="${f.id}" name="${f.id}" class="input-field">${f.options}</select>`
                        : `<input type="${f.type || 'text'}" id="${f.id}" name="${f.id}" value="${f.value || ''}" class="input-field">`
                    }
                </div>
            `).join('');
            const submitButton = document.createElement('button');
            submitButton.type = 'submit';
            submitButton.className = 'w-full btn btn-primary mt-6';
            submitButton.textContent = 'Simpan';
            form.appendChild(submitButton);
            form.addEventListener('submit', (e) => {
                e.preventDefault();
                onSubmit(form);
            });
            return form;
        }
        
        // --- Modal & Form Handling ---
        function showModal(title, formElement) {
            modalTitle.textContent = title;
            modalBody.innerHTML = '';
            modalBody.appendChild(formElement);
            modal.classList.add('active');
        }

        function hideModal() {
            modal.classList.remove('active');
            modalBody.innerHTML = '';
        }

        // --- Event Listeners ---
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            loginError.textContent = '';
            const email = loginForm.email.value;
            const password = loginForm.password.value;
            const { error } = await supabaseClient.auth.signInWithPassword({ email, password });
            if (error) loginError.textContent = 'Login gagal: ' + error.message;
            else init();
        });

        logoutButton.addEventListener('click', async () => {
            await supabaseClient.auth.signOut();
            location.reload();
        });

        // FIX: Replaced individual listeners with event delegation on the nav container
        sidebarNav.addEventListener('click', (e) => {
            const link = e.target.closest('.nav-link');
            if (link) {
                e.preventDefault();
                const targetId = link.dataset.target;
                
                dashboardContents.forEach(content => content.classList.add('hidden'));
                document.getElementById(targetId).classList.remove('hidden');
                
                document.querySelectorAll('.nav-link').forEach(nav => nav.classList.remove('bg-gray-700'));
                link.classList.add('bg-gray-700');
            }
        });

        modalClose.addEventListener('click', hideModal);
        
        document.body.addEventListener('click', async e => {
            const target = e.target;
            
            // --- Program Management ---
            if (target.id === 'add-track-button') {
                const form = createForm([{label: 'Nama Track', id: 'name'}], async formEl => {
                    await supabaseClient.from('tracks').insert({name: formEl.name.value});
                    hideModal(); loadAllData();
                });
                showModal('Tambah Track Baru', form);
            }
            if (target.matches('.edit-track-btn')) {
                const track = programCache.find(t => t.id == target.dataset.id);
                const form = createForm([{label: 'Nama Track', id: 'name', value: track.name}], async formEl => {
                    await supabaseClient.from('tracks').update({name: formEl.name.value}).eq('id', track.id);
                    hideModal(); loadAllData();
                });
                showModal('Edit Track', form);
            }
            if (target.matches('.add-topic-btn')) {
                const trackId = target.dataset.trackId;
                const form = createForm([{label: 'Nama Topik', id: 'name'}], async formEl => {
                    await supabaseClient.from('topics').insert({name: formEl.name.value, track_id: trackId});
                    hideModal(); loadAllData();
                });
                showModal('Tambah Topik Baru', form);
            }
            if (target.matches('.add-paper-btn')) {
                const topicId = target.dataset.topicId;
                const speakerOptions = speakersCache.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
                const form = createForm([
                    {label: 'Judul Paper', id: 'title'},
                    {label: 'Abstrak', id: 'abstract', type: 'textarea'},
                    {label: 'Ruangan', id: 'room'},
                    {label: 'Pembicara', id: 'speaker_id', type: 'select', options: `<option value="">Pilih Pembicara</option>${speakerOptions}`},
                    {label: 'Waktu Mulai', id: 'start_time', type: 'datetime-local'},
                    {label: 'Waktu Selesai', id: 'end_time', type: 'datetime-local'},
                ], async formEl => {
                    await supabaseClient.from('papers').insert({
                        topic_id: topicId,
                        title: formEl.title.value,
                        abstract: formEl.abstract.value,
                        room: formEl.room.value,
                        speaker_id: formEl.speaker_id.value || null,
                        start_time: formEl.start_time.value || null,
                        end_time: formEl.end_time.value || null,
                    });
                    hideModal(); loadAllData();
                });
                showModal('Tambah Paper Baru', form);
            }

            // --- Speaker Management ---
            if (target.id === 'add-speaker-button') {
                const form = createForm([{label: 'Nama', id: 'name'}, {label: 'URL Avatar', id: 'avatar_url'}], async formEl => {
                    await supabaseClient.from('speakers').insert({name: formEl.name.value, avatar_url: formEl.avatar_url.value});
                    hideModal(); loadAllData();
                });
                showModal('Tambah Pembicara', form);
            }
            if (target.matches('.edit-speaker-btn')) {
                const speaker = speakersCache.find(s => s.id == target.dataset.id);
                const form = createForm([{label: 'Nama', id: 'name', value: speaker.name}, {label: 'URL Avatar', id: 'avatar_url', value: speaker.avatar_url}], async formEl => {
                    await supabaseClient.from('speakers').update({name: formEl.name.value, avatar_url: formEl.avatar_url.value}).eq('id', speaker.id);
                    hideModal(); loadAllData();
                });
                showModal('Edit Pembicara', form);
            }
            if (target.matches('.delete-speaker-btn')) {
                if (confirm(`Anda yakin ingin menghapus pembicara "${target.dataset.name}"?`)) {
                    await supabaseClient.from('speakers').delete().eq('id', target.dataset.id);
                    loadAllData();
                }
            }
        });

        // --- Inisialisasi Aplikasi ---
        init();
    </script>
</body>
</html>
