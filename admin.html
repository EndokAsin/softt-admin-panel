<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - AICOMS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .form-label { @apply block text-sm font-medium text-gray-700; }
        .form-input { @apply mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-red-500 focus:border-red-500 sm:text-sm; }
        .btn { @apply inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white transition-colors duration-200; }
        .btn-red { @apply bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500; }
        .btn-blue { @apply bg-blue-600 hover:bg-blue-700; }
        .btn-gray { @apply bg-gray-500 hover:bg-gray-600; }
        .notification { @apply fixed top-5 right-5 w-auto max-w-sm p-4 rounded-lg shadow-lg text-white transform translate-x-full transition-transform duration-300 ease-out; }
        .notification.show { @apply translate-x-0; }
        .tag-container { @apply flex flex-wrap gap-2 p-2 border border-gray-200 rounded-md min-h-[42px] bg-gray-50; }
        .tag-item { @apply flex items-center bg-red-100 text-red-800 text-sm font-medium px-3 py-1 rounded-full; }
        .tag-delete { @apply ml-2 w-4 h-4 text-red-600 hover:text-red-800 cursor-pointer; }
    </style>
</head>
<body class="bg-gray-100">

    <div id="notification-container"></div>

    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        <div class="mb-8">
            <h1 class="text-3xl font-bold text-gray-900">Admin Panel AICOMS</h1>
            <p class="text-gray-600">Kelola data anggota tim peneliti.</p>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <div id="form-card" class="lg:col-span-1 bg-white p-6 rounded-lg shadow-md transition-colors duration-300">
                <h2 id="form-title" class="text-xl font-bold mb-4 text-gray-800">Tambah Anggota Baru</h2>
                <form id="member-form" class="space-y-6">
                    <input type="hidden" id="member-id">
                    <input type="hidden" id="existing-foto-url">

                    <div>
                        <label class="form-label">Foto Profil</label>
                        <div class="mt-1 flex items-center space-x-4">
                            <img id="foto-preview" src="https://placehold.co/100x100/EFEFEF/AAAAAA?text=Foto" class="w-24 h-24 rounded-full object-cover bg-gray-100">
                            <input type="file" id="foto-upload" accept="image/*" class="hidden">
                            <button type="button" onclick="document.getElementById('foto-upload').click()" class="btn bg-white text-gray-700 border border-gray-300 hover:bg-gray-50">Ganti Foto</button>
                        </div>
                    </div>

                    <div>
                        <label for="nama" class="form-label">Nama Lengkap</label>
                        <input type="text" id="nama" class="form-input" required>
                    </div>
                    <div>
                        <label for="jabatan" class="form-label">Jabatan</label>
                        <input type="text" id="jabatan" class="form-input">
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="prodi" class="form-label">Program Studi</label>
                            <input type="text" id="prodi" class="form-input">
                        </div>
                        <div>
                            <label for="universitas_asal" class="form-label">Universitas Asal</label>
                            <input type="text" id="universitas_asal" class="form-input">
                        </div>
                    </div>

                    <div>
                        <label class="form-label">Pendidikan</label>
                        <div id="pendidikan-container" class="tag-container"></div>
                        <input type="text" id="pendidikan-input" class="form-input" placeholder="Ketik lalu tekan Enter">
                    </div>
                    <div>
                        <label class="form-label">Topik Penelitian</label>
                        <div id="topik_penelitian-container" class="tag-container"></div>
                        <input type="text" id="topik_penelitian-input" class="form-input" placeholder="Ketik lalu tekan Enter">
                    </div>
                    <div>
                        <label class="form-label">Publikasi</label>
                        <div id="publikasi-container" class="tag-container"></div>
                        <input type="text" id="publikasi-input" class="form-input" placeholder="Ketik lalu tekan Enter">
                    </div>
                    
                    <div class="flex items-center space-x-4 pt-4 border-t">
                        <button type="submit" id="submit-button" class="btn btn-red w-full">Simpan Anggota</button>
                        <button type="button" id="cancel-edit-button" class="btn btn-gray hidden">Batal</button>
                    </div>
                </form>
            </div>

            <div class="lg:col-span-2 space-y-8">
                 <div class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-xl font-bold mb-4">Unggah Data dari CSV</h2>
                    <p class="text-sm text-gray-600 mb-4">Fitur unggah CSV tidak mendukung unggah foto. Foto harus ditambahkan secara manual.</p>
                    <div class="flex items-center space-x-4">
                        <input type="file" id="csv-file" accept=".csv" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-red-50 file:text-red-700 hover:file:bg-red-100"/>
                        <button id="upload-csv-button" class="btn btn-blue flex-shrink-0">Unggah</button>
                    </div>
                </div>
                <div class="bg-white rounded-lg shadow-md">
                    <div class="p-6 border-b"><h2 class="text-xl font-bold">Daftar Anggota Tim</h2></div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Anggota</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Jabatan</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="members-table-body" class="bg-white divide-y divide-gray-200">
                                <tr><td colspan="3" class="p-4 text-center text-gray-500">Memuat data...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // --- KONEKSI SUPABASE ---
        const SUPABASE_URL = 'https://ostoxfgxxjfbvfouydiv.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9zdG94Zmd4eGpmYnZmb3V5ZGl2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE2OTI1MzcsImV4cCI6MjA2NzI2ODUzN30.PqEWjFaTGZZmQ5o2rNmv2G34k1-UKfloU_ETDxhwcro';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // --- ELEMEN DOM ---
        const form = document.getElementById('member-form');
        const fotoUploadInput = document.getElementById('foto-upload');
        const fotoPreview = document.getElementById('foto-preview');
        const existingFotoUrlInput = document.getElementById('existing-foto-url');
        const formCard = document.getElementById('form-card');
        const formTitle = document.getElementById('form-title');
        const memberIdInput = document.getElementById('member-id');
        const submitButton = document.getElementById('submit-button');
        const cancelEditBtn = document.getElementById('cancel-edit-button');
        const tableBody = document.getElementById('members-table-body');
        const notificationContainer = document.getElementById('notification-container');

        // --- FUNGSI NOTIFIKASI ---
        function showNotification(message, type = 'success') {
            const bgColor = type === 'success' ? 'bg-green-500' : 'bg-red-500';
            const notification = document.createElement('div');
            notification.className = `notification ${bgColor}`;
            notification.textContent = message;
            notificationContainer.appendChild(notification);
            setTimeout(() => notification.classList.add('show'), 10);
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // --- FUNGSI CRUD ---
        async function fetchMembers() {
            tableBody.innerHTML = '<tr><td colspan="3" class="p-4 text-center text-gray-500">Memuat data...</td></tr>';
            const { data, error } = await supabase.from('anggota').select('*').order('nama', { ascending: true });
            if (error) {
                console.error('Error fetching members:', error);
                tableBody.innerHTML = '<tr><td colspan="3" class="p-4 text-center text-red-500">Gagal memuat data.</td></tr>';
                return;
            }
            tableBody.innerHTML = '';
            data.forEach(member => {
                const row = `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="flex items-center">
                                <div class="flex-shrink-0 h-10 w-10">
                                    <img class="h-10 w-10 rounded-full object-cover" src="${member.foto_url || 'https://placehold.co/40x40/EFEFEF/AAAAAA?text=N/A'}" alt="">
                                </div>
                                <div class="ml-4">
                                    <div class="text-sm font-medium text-gray-900">${member.nama}</div>
                                </div>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap"><div class="text-sm text-gray-500">${member.jabatan || ''}</div></td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium space-x-2">
                            <button class="text-green-600 hover:text-green-900" onclick="editMember(${member.id})">Edit</button>
                            <button class="text-red-600 hover:text-red-900" onclick="deleteMember(${member.id})">Hapus</button>
                        </td>
                    </tr>
                `;
                tableBody.innerHTML += row;
            });
        }

        window.editMember = async (id) => {
            const { data, error } = await supabase.from('anggota').select('*').eq('id', id).single();
            if (error) return showNotification("Gagal mengambil data untuk diedit", "error");
            
            resetForm();
            formTitle.innerText = 'Edit Anggota';
            submitButton.innerText = 'Update Anggota';
            formCard.classList.add('bg-yellow-50');

            memberIdInput.value = data.id;
            existingFotoUrlInput.value = data.foto_url || '';
            fotoPreview.src = data.foto_url || 'https://placehold.co/100x100/EFEFEF/AAAAAA?text=Foto';

            ['nama', 'jabatan', 'prodi', 'universitas_asal'].forEach(field => {
                document.getElementById(field).value = data[field] || '';
            });
            
            ['pendidikan', 'topik_penelitian', 'publikasi'].forEach(key => {
                if (Array.isArray(data[key])) data[key].forEach(item => addTag(key, item));
            });

            cancelEditBtn.classList.remove('hidden');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        window.deleteMember = async (id) => {
            if (!confirm('Apakah Anda yakin ingin menghapus anggota ini?')) return;
            const { data, error } = await supabase.from('anggota').delete().eq('id', id).select().single();
            if (error) {
                showNotification(`Gagal menghapus anggota: ${error.message}`, 'error');
            } else {
                // Hapus foto dari storage jika ada
                if (data.foto_url) {
                    const fileName = data.foto_url.split('/').pop();
                    await supabase.storage.from('foto-anggota').remove([fileName]);
                }
                showNotification('Anggota berhasil dihapus.', 'success');
                fetchMembers();
            }
        }
        
        function resetForm() {
            form.reset();
            memberIdInput.value = '';
            existingFotoUrlInput.value = '';
            fotoPreview.src = 'https://placehold.co/100x100/EFEFEF/AAAAAA?text=Foto';
            formTitle.innerText = 'Tambah Anggota Baru';
            submitButton.innerText = 'Simpan Anggota';
            formCard.classList.remove('bg-yellow-50');
            cancelEditBtn.classList.add('hidden');
            ['pendidikan', 'topik_penelitian', 'publikasi'].forEach(key => {
                document.getElementById(`${key}-container`).innerHTML = '';
            });
        }

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = memberIdInput.value;
            submitButton.disabled = true;
            submitButton.textContent = 'Menyimpan...';

            let fotoUrl = existingFotoUrlInput.value;
            const file = fotoUploadInput.files[0];

            // 1. Proses upload foto jika ada file baru
            if (file) {
                const fileName = `${Date.now()}-${file.name}`;
                const { error: uploadError } = await supabase.storage
                    .from('foto-anggota')
                    .upload(fileName, file);

                if (uploadError) {
                    showNotification(`Gagal mengunggah foto: ${uploadError.message}`, 'error');
                    submitButton.disabled = false;
                    submitButton.textContent = id ? 'Update Anggota' : 'Simpan Anggota';
                    return;
                }

                const { data: urlData } = supabase.storage
                    .from('foto-anggota')
                    .getPublicUrl(fileName);
                fotoUrl = urlData.publicUrl;
            }
            
            // 2. Siapkan data anggota
            const getTags = (key) => Array.from(document.querySelectorAll(`#${key}-container .tag-text`)).map(tag => tag.textContent);
            const memberData = {
                nama: document.getElementById('nama').value,
                jabatan: document.getElementById('jabatan').value,
                prodi: document.getElementById('prodi').value,
                universitas_asal: document.getElementById('universitas_asal').value,
                foto_url: fotoUrl,
                pendidikan: getTags('pendidikan'),
                topik_penelitian: getTags('topik_penelitian'),
                publikasi: getTags('publikasi'),
            };

            // 3. Simpan data ke database
            const { error } = id
                ? await supabase.from('anggota').update(memberData).eq('id', id)
                : await supabase.from('anggota').insert([memberData]);

            if (error) {
                showNotification(`Gagal menyimpan data: ${error.message}`, 'error');
            } else {
                showNotification('Data berhasil disimpan!', 'success');
                resetForm();
                fetchMembers();
            }
            submitButton.disabled = false;
            submitButton.textContent = id ? 'Update Anggota' : 'Simpan Anggota';
        });

        cancelEditBtn.addEventListener('click', resetForm);

        // --- LOGIKA INPUT TAG ---
        function addTag(key, value) {
            if (!value.trim()) return;
            const container = document.getElementById(`${key}-container`);
            const tag = document.createElement('div');
            tag.className = 'tag-item';
            tag.innerHTML = `<span class="tag-text">${value.trim()}</span><svg class="tag-delete" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" /></svg>`;
            tag.querySelector('.tag-delete').addEventListener('click', () => tag.remove());
            container.appendChild(tag);
        }

        ['pendidikan', 'topik_penelitian', 'publikasi'].forEach(key => {
            const input = document.getElementById(`${key}-input`);
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    addTag(key, input.value);
                    input.value = '';
                }
            });
        });
        
        // Pratinjau foto
        fotoUploadInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                fotoPreview.src = URL.createObjectURL(file);
            }
        });

        // --- UPLOAD CSV ---
        const uploadCsvBtn = document.getElementById('upload-csv-button');
        const csvFileInput = document.getElementById('csv-file');
        uploadCsvBtn.addEventListener('click', () => { /* ... logika CSV tetap sama ... */ });

        // --- INIT ---
        fetchMembers();
    </script>
</body>
</html>
